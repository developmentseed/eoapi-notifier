apiVersion: v1
kind: Pod
metadata:
  name: "{{ include "eoapi-notifier.fullname" . }}-test-config"
  labels:
    {{- include "eoapi-notifier.labels" . | nindent 4 }}
    app.kubernetes.io/component: test
  annotations:
    "helm.sh/hook": test
    "helm.sh/hook-weight": "2"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
spec:
  restartPolicy: Never
  containers:
  - name: config-test
    image: alpine:3.19
    command:
    - /bin/sh
    - -c
    - |
      set -e
      echo "üß™ Testing eoapi-notifier configuration..."

      # Test that config file exists and is readable
      if [ ! -f /app/config/config.yaml ]; then
        echo "‚ùå Config file not found at /app/config/config.yaml"
        exit 1
      fi
      echo "‚úÖ Config file exists"

      # Test that config contains expected sections
      if ! grep -q "sources:" /app/config/config.yaml; then
        echo "‚ùå Config missing sources section"
        exit 1
      fi
      echo "‚úÖ Sources section found"

      if ! grep -q "outputs:" /app/config/config.yaml; then
        echo "‚ùå Config missing outputs section"
        exit 1
      fi
      echo "‚úÖ Outputs section found"

      # Test that environment variables from secret are available (if configured)
      if [ -n "$PGSTAC_USER" ] && [ -n "$PGSTAC_PASSWORD" ]; then
        echo "‚úÖ PostgreSQL credentials available via environment variables"
        echo "‚úÖ Environment variables are being used for secrets"
      else
        echo "‚ö†Ô∏è  PostgreSQL credentials not configured via environment (this may be expected)"
      fi

      # Test config file format
      cat /app/config/config.yaml | head -20

      echo "‚úÖ Configuration test passed"
    env:
    {{- range $source := .Values.config.sources }}
    {{- if and (eq $source.type "pgstac") $source.config.connection.existingSecret.name }}
    {{- $secret := $source.config.connection.existingSecret }}
    - name: PGSTAC_HOST
      valueFrom:
        secretKeyRef:
          name: {{ $secret.name }}
          key: {{ $secret.keys.host }}
    - name: PGSTAC_PORT
      valueFrom:
        secretKeyRef:
          name: {{ $secret.name }}
          key: {{ $secret.keys.port }}
    - name: PGSTAC_DATABASE
      valueFrom:
        secretKeyRef:
          name: {{ $secret.name }}
          key: {{ $secret.keys.database }}
    - name: PGSTAC_USER
      valueFrom:
        secretKeyRef:
          name: {{ $secret.name }}
          key: {{ $secret.keys.username }}
    - name: PGSTAC_PASSWORD
      valueFrom:
        secretKeyRef:
          name: {{ $secret.name }}
          key: {{ $secret.keys.password }}
    {{- end }}
    {{- end }}
    volumeMounts:
    - name: config
      mountPath: /app/config
      readOnly: true
  volumes:
  - name: config
    configMap:
      name: {{ include "eoapi-notifier.fullname" . }}
  serviceAccountName: {{ include "eoapi-notifier.serviceAccountName" . }}
