apiVersion: v1
kind: Pod
metadata:
  name: "{{ include "eoapi-notifier.fullname" . }}-test-config"
  labels:
    {{- include "eoapi-notifier.labels" . | nindent 4 }}
    app.kubernetes.io/component: test
  annotations:
    "helm.sh/hook": test
    "helm.sh/hook-weight": "2"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
spec:
  restartPolicy: Never
  initContainers:
  - name: config-processor
    image: alpine:3.19
    command:
    - /bin/sh
    - -c
    - |
      set -e
      echo "Processing configuration for config test..."

      # Read the template config and replace placeholders
      sed -e "s/__POSTGRES_USERNAME__/${POSTGRES_USERNAME}/g" \
          -e "s/__POSTGRES_PASSWORD__/${POSTGRES_PASSWORD}/g" \
          /app/config-template/config.yaml > /app/config-processed/config.yaml

      echo "Config test configuration processed successfully"
    env:
    - name: POSTGRES_USERNAME
      valueFrom:
        secretKeyRef:
          name: {{ include "eoapi-notifier.fullname" . }}-postgresql
          key: username
    - name: POSTGRES_PASSWORD
      valueFrom:
        secretKeyRef:
          name: {{ include "eoapi-notifier.fullname" . }}-postgresql
          key: password
    volumeMounts:
    - name: config-template
      mountPath: /app/config-template
      readOnly: true
    - name: config-processed
      mountPath: /app/config-processed
    securityContext:
      allowPrivilegeEscalation: false
      capabilities:
        drop:
        - ALL
      readOnlyRootFilesystem: false
      runAsNonRoot: true
      runAsUser: 1000
  containers:
  - name: config-test
    image: alpine:3.19
    command:
    - /bin/sh
    - -c
    - |
      set -e
      echo "üß™ Testing eoapi-notifier configuration..."

      # Test that config file exists and is readable
      if [ ! -f /app/config/config.yaml ]; then
        echo "‚ùå Config file not found at /app/config/config.yaml"
        exit 1
      fi
      echo "‚úÖ Config file exists"

      # Test that config contains expected sections
      if ! grep -q "sources:" /app/config/config.yaml; then
        echo "‚ùå Config missing sources section"
        exit 1
      fi
      echo "‚úÖ Sources section found"

      if ! grep -q "outputs:" /app/config/config.yaml; then
        echo "‚ùå Config missing outputs section"
        exit 1
      fi
      echo "‚úÖ Outputs section found"

      # Test that environment variables from secret are available
      if [ -z "$POSTGRES_USERNAME" ]; then
        echo "‚ùå POSTGRES_USERNAME not set"
        exit 1
      fi
      echo "‚úÖ PostgreSQL username available"

      if [ -z "$POSTGRES_PASSWORD" ]; then
        echo "‚ùå POSTGRES_PASSWORD not set"
        exit 1
      fi
      echo "‚úÖ PostgreSQL password available"

      # Test config file format
      cat /app/config/config.yaml | head -20

      echo "‚úÖ Configuration test passed"
    env:
    - name: POSTGRES_USERNAME
      valueFrom:
        secretKeyRef:
          name: {{ include "eoapi-notifier.fullname" . }}-postgresql
          key: username
    - name: POSTGRES_PASSWORD
      valueFrom:
        secretKeyRef:
          name: {{ include "eoapi-notifier.fullname" . }}-postgresql
          key: password
    volumeMounts:
    - name: config-processed
      mountPath: /app/config
      readOnly: true
  volumes:
  - name: config-template
    configMap:
      name: {{ include "eoapi-notifier.fullname" . }}
  - name: config-processed
    emptyDir: {}
  serviceAccountName: {{ include "eoapi-notifier.serviceAccountName" . }}
