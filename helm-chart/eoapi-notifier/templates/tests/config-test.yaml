apiVersion: v1
kind: Pod
metadata:
  name: "{{ include "eoapi-notifier.fullname" . }}-test-config"
  labels:
    {{- include "eoapi-notifier.labels" . | nindent 4 }}
    app.kubernetes.io/component: test
  annotations:
    "helm.sh/hook": test
    "helm.sh/hook-weight": "2"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
spec:
  restartPolicy: Never
  containers:
  - name: config-test
    image: alpine:3.19
    command:
    - /bin/sh
    - -c
    - |
      set -e
      echo "üß™ Testing eoapi-notifier configuration..."

      # Test that config file exists and is readable
      if [ ! -f /app/config/config.yaml ]; then
        echo "‚ùå Config file not found at /app/config/config.yaml"
        exit 1
      fi
      echo "‚úÖ Config file exists"

      # Test that config contains expected sections
      if ! grep -q "sources:" /app/config/config.yaml; then
        echo "‚ùå Config missing sources section"
        exit 1
      fi
      echo "‚úÖ Sources section found"

      if ! grep -q "outputs:" /app/config/config.yaml; then
        echo "‚ùå Config missing outputs section"
        exit 1
      fi
      echo "‚úÖ Outputs section found"

      # Test that environment variables from secret are available
      if [ -z "$POSTGRES_USERNAME" ]; then
        echo "‚ùå POSTGRES_USERNAME not set"
        exit 1
      fi
      echo "‚úÖ PostgreSQL username available"

      if [ -z "$POSTGRES_PASSWORD" ]; then
        echo "‚ùå POSTGRES_PASSWORD not set"
        exit 1
      fi
      echo "‚úÖ PostgreSQL password available"

      # Test that environment variables work (they should override config)
      echo "Testing environment variable override capability..."
      if [ "$POSTGRES_USERNAME" != "postgres" ] || [ "$POSTGRES_PASSWORD" != "password" ]; then
        echo "‚úÖ Environment variables are being used for secrets"
      else
        echo "‚ö†Ô∏è  Using default values (this may be expected in some environments)"
      fi

      # Test config file format
      cat /app/config/config.yaml | head -20

      echo "‚úÖ Configuration test passed"
    env:
    - name: POSTGRES_USERNAME
      valueFrom:
        secretKeyRef:
          name: {{ include "eoapi-notifier.fullname" . }}-postgresql
          key: username
    - name: POSTGRES_PASSWORD
      valueFrom:
        secretKeyRef:
          name: {{ include "eoapi-notifier.fullname" . }}-postgresql
          key: password
    volumeMounts:
    - name: config
      mountPath: /app/config
      readOnly: true
  volumes:
  - name: config
    configMap:
      name: {{ include "eoapi-notifier.fullname" . }}
  serviceAccountName: {{ include "eoapi-notifier.serviceAccountName" . }}
